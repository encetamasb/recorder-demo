<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>Recorder</title>
  <script src="app.js"></script>
</head>
<body>
    <div id="app"></div>
    <script>
        var app = Elm.Main.init({
            node: document.getElementById("app"),
            flags: {}
        });

        var recorder, curStream;
        var chunks = [];

        var chunkDelta = 1000;

        app.ports.toRecorder.subscribe(function(msg) {
            switch (msg.event) {
                case "started":
                    navigator.mediaDevices.getUserMedia({
                        audio: true,
                        video: false
                    }).then(function(stream) {
                        chunks = [];

                        curStream = stream;
                        recorder = new MediaRecorder(stream);

                        recorder.ondataavailable = function(e) {
                            chunks.push(e.data);
                            e.data.arrayBuffer().then(function(buffer) {
                                app.ports.fromRecorder.send({
                                    event: "datachunk",
                                    id: msg.id,
                                    size: buffer.byteLength
                                });
                            });
                        };

                        recorder.start(chunkDelta);

                        app.ports.fromRecorder.send({
                            event: "started",
                            id: msg.id,
                        });
                    })

                    break;
                case "stopped":
                    recorder.stop()

                    curStream.getAudioTracks().forEach(function(track){
                        track.stop();
                    });

                    var blob = chunks.reduce(function(a, b) {
                        return new Blob([a, b], {type: a.type})
                    });

                    var url = URL.createObjectURL(blob);

                    console.log(blob, url);

                    app.ports.fromRecorder.send({
                        event: "stopped",
                        id: msg.id,
                        url: url,
                        mime: blob.type
                    });
                    break;
                default:
                    console.log("ops", msg);
            }
        });

    </script>
</body>
</html>
